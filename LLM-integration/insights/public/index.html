<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VisionXI Insights</title>
    <style>
      :root {
        --bg: #0f1115;
        --panel: #171a21;
        --text: #e9edf5;
        --muted: #9aa3b2;
        --accent: #6ee7ff;
        --danger: #ff8b8b;
        --good: #9cff9c;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Space Grotesk", "IBM Plex Sans", system-ui, sans-serif;
        background: radial-gradient(800px 400px at 10% 0%, #1b2230, var(--bg));
        color: var(--text);
      }
      header {
        padding: 24px;
        border-bottom: 1px solid #232838;
      }
      h1 { margin: 0; font-size: 24px; letter-spacing: 0.4px; }
      .sub { color: var(--muted); margin-top: 6px; font-size: 14px; }
      main {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        padding: 16px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid #232838;
        border-radius: 12px;
        padding: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      input, select, button {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #2a3145;
        background: #12151c;
        color: var(--text);
      }
      button {
        background: #172433;
        border-color: #2d394f;
        cursor: pointer;
      }
      button:hover { border-color: var(--accent); }
      .list { display: grid; gap: 10px; }
      .card {
        background: #141820;
        border: 1px solid #232838;
        border-radius: 10px;
        padding: 12px;
      }
      .tag {
        display: inline-block;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 20px;
        background: #20283a;
        color: var(--muted);
      }
      .risk { color: var(--danger); }
      .good { color: var(--good); }
      .muted { color: var(--muted); }
      @media (max-width: 900px) {
        main { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>VisionXI Insights</h1>
      <div class="sub">Live session insights and stats</div>
    </header>
    <main>
      <section class="panel">
        <div class="row">
          <label for="sessionSelect" class="muted">Session</label>
          <select id="sessionSelect"></select>
          <button id="refreshBtn">Refresh</button>
        </div>
        <div class="row">
          <input id="tsInput" type="number" step="0.1" placeholder="Timestamp (sec)" />
          <select id="modeSelect">
            <option value="player">player</option>
            <option value="team">team</option>
          </select>
          <button id="clickBtn">Generate Insight</button>
        </div>
        <div id="stats" class="list"></div>
      </section>
      <section class="panel">
        <div class="row">
          <div class="muted">Insights</div>
        </div>
        <div id="insights" class="list"></div>
      </section>
    </main>
    <script>
      async function fetchSessions() {
        const res = await fetch("/sessions");
        return res.json();
      }
      async function fetchReport(sessionId) {
        const res = await fetch(`/sessions/${sessionId}/report`);
        return res.json();
      }
      async function postClick(sessionId, ts, mode) {
        const res = await fetch("/click", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId, ts, mode })
        });
        return res.json();
      }
      function renderStats(stats) {
        const el = document.getElementById("stats");
        el.innerHTML = "";
        const latest = stats && stats.length ? stats[0] : null;
        if (!latest) {
          el.innerHTML = "<div class='card muted'>No stats yet</div>";
          return;
        }
        const data = JSON.parse(latest.json);
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div><span class="tag">${latest.kind}</span></div>
          <div class="muted">Top event: <span class="good">${data.topEvent}</span></div>
          <div class="muted">Avg pressure: ${data.avgPressure?.toFixed(2)}</div>
          <div class="muted">Risk count: <span class="risk">${data.riskCount}</span></div>
          <div class="muted">Counts: ${JSON.stringify(data.counts)}</div>
        `;
        el.appendChild(card);
      }
      function renderInsights(insights) {
        const el = document.getElementById("insights");
        el.innerHTML = "";
        if (!insights || !insights.length) {
          el.innerHTML = "<div class='card muted'>No insights yet</div>";
          return;
        }
        insights.forEach((ins) => {
          const data = JSON.parse(ins.json);
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div><strong>${data.title}</strong></div>
            <div class="muted">${data.what_happened}</div>
            <div class="muted">${data.why_it_matters}</div>
            <div class="muted">How: ${data.how_to_improve.join(" | ")}</div>
            ${data.injury_note ? `<div class="risk">${data.injury_note}</div>` : ""}
            <div class="muted">Drill: ${data.drill.name}</div>
          `;
          el.appendChild(card);
        });
      }
      async function refresh() {
        const sessions = await fetchSessions();
        const select = document.getElementById("sessionSelect");
        select.innerHTML = "";
        sessions.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.sessionId;
          opt.textContent = s.sessionId;
          select.appendChild(opt);
        });
        if (sessions.length) {
          const report = await fetchReport(sessions[0].sessionId);
          renderStats(report.stats);
          renderInsights(report.insights);
        }
      }
      document.getElementById("refreshBtn").onclick = refresh;
      document.getElementById("clickBtn").onclick = async () => {
        const sessionId = document.getElementById("sessionSelect").value;
        const ts = Number(document.getElementById("tsInput").value || 0);
        const mode = document.getElementById("modeSelect").value;
        if (!sessionId || !ts) return;
        await postClick(sessionId, ts, mode);
        const report = await fetchReport(sessionId);
        renderStats(report.stats);
        renderInsights(report.insights);
      };
      refresh();
    </script>
  </body>
</html>

